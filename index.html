<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Kids School Daily Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        /* 送信済みマーク用のスタイル */
        .report-sent { background-color: #e6fffa; /* Tailwind bg-green-50相当 */ }
        /* チェックボックスのカスタムスタイル */
        .report-sent-checkbox-label { display: flex; align-items: center; cursor: pointer; }
        .report-sent-checkbox { transform: scale(1.2); margin-right: 0.5rem; }
        .report-sent-label-text { font-size: 0.75rem; /* text-xs */ color: #4a5568; /* text-gray-600 */ }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">

        <!-- ヘッダー -->
        <header class="mb-6">
            <!-- スマホ用にフォントサイズを調整 -->
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Tree Kids School Daily Report</h1>
            <p class="text-gray-600">日々の療育内容を記録し、チームで共有しましょう。</p>
        </header>

        <!-- タブ切り替え -->
        <div class="border-b border-gray-200 mb-6">
            <!-- スマホでタブが多い場合も横スクロールできるように -->
            <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                <button id="tab-daily" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">
                    日々の記録
                </button>
                <button id="tab-users" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    利用者管理
                </button>
                <button id="tab-staff" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    スタッフ管理
                </button>
            </nav>
        </div>

        <!-- コンテンツエリア -->
        <main>
            <!-- 日々の記録タブ -->
            <div id="content-daily">
                <div class="mb-4 flex items-center space-x-4">
                    <label for="date-picker" class="font-medium">日付:</label>
                    <input type="date" id="date-picker" class="border-gray-300 rounded-md shadow-sm">
                </div>
                 <!-- 検索エリア -->
                <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">記録検索</h3>
                    <!-- スマホで縦積み、PCで横並び -->
                    <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                        <input type="text" id="search-input" placeholder="キーワードを入力 (例: 利用者名, パズル, SST)" class="flex-grow border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 w-full">
                        <button id="search-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-full sm:w-auto">検索</button>
                        <button id="clear-search-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full sm:w-auto hidden">クリア</button>
                    </div>
                    <div id="search-results-container" class="mt-4 hidden">
                         <h4 class="text-md font-semibold text-gray-600 mb-2">検索結果:</h4>
                         <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- 検索結果がここに表示されます -->
                         </div>
                    </div>
                </div>
                <!-- 日付ごとのリスト表示エリア -->
                <div id="daily-view-container">
                    <div id="daily-user-list" class="space-y-3">
                        <!-- 利用者リストがここに動的に挿入されます -->
                    </div>
                    <p id="no-users-message-daily" class="text-center text-gray-500 py-8 hidden">利用者が登録されていません。「利用者管理」タブから利用者を追加してください。</p>
                </div>
            </div>

            <!-- 利用者管理タブ -->
            <div id="content-users" class="hidden">
                 <!-- スマホで縦積み、PCで横並び -->
                 <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 space-y-4 sm:space-y-0">
                     <!-- データエクスポートセクション -->
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 w-full sm:w-auto">
                         <h3 class="text-lg font-semibold mb-2 text-gray-700">データエクスポート (CSV)</h3>
                         <!-- スマホで縦積み、PCで横並び -->
                         <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                             <button id="export-users-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">利用者リスト</button>
                             <button id="export-records-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">全記録データ</button>
                         </div>
                     </div>
                     <button id="add-user-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">
                         利用者を新規登録
                     </button>
                 </div>
                <div id="user-management-list" class="space-y-3">
                    <!-- 利用者管理リストがここに動的に挿入されます -->
                </div>
                <p id="no-users-message-manage" class="text-center text-gray-500 py-8 hidden">利用者が登録されていません。</p>
            </div>

            <!-- スタッフ管理タブ -->
            <div id="content-staff" class="hidden">
                <div class="flex justify-end mb-4">
                    <button id="add-staff-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">
                        スタッフを新規登録
                    </button>
                </div>
                <div id="staff-management-list" class="space-y-3">
                    <!-- スタッフ管理リストがここに動的に挿入されます -->
                </div>
                <p id="no-staff-message-manage" class="text-center text-gray-500 py-8 hidden">スタッフが登録されていません。</p>
            </div>
        </main>
    </div>

    <!-- 利用者登録・編集モーダル -->
    <div id="user-modal" class="fixed inset-0 z-20 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- スマホ用にフォントサイズを調整 -->
            <h3 id="user-modal-title" class="text-xl sm:text-2xl font-bold mb-4">利用者を新規登録</h3>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="space-y-4">
                    <div>
                        <label for="user-name" class="block text-sm font-medium text-gray-700">氏名</label>
                        <input type="text" id="user-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="user-nickname" class="block text-sm font-medium text-gray-700">呼び方 (ツリー通信で使うお名前)</label>
                        <input type="text" id="user-nickname" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <!-- スマホでボタンを縦積み -->
                <div class="mt-6 flex flex-col-reverse sm:flex-row justify-end sm:space-x-3 space-y-2 sm:space-y-0 space-y-reverse">
                    <button type="button" id="user-modal-cancel" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none w-full sm:w-auto">キャンセル</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">保存</button>
                </div>
            </form>
        </div>
    </div>

     <!-- スタッフ登録・編集モーダル -->
    <div id="staff-modal" class="fixed inset-0 z-20 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- スマホ用にフォントサイズを調整 -->
            <h3 id="staff-modal-title" class="text-xl sm:text-2xl font-bold mb-4">スタッフを新規登録</h3>
            <form id="staff-form">
                <input type="hidden" id="staff-id">
                <div class="space-y-4">
                    <div>
                        <label for="staff-name" class="block text-sm font-medium text-gray-700">スタッフ名</label>
                        <input type="text" id="staff-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <!-- スマホでボタンを縦積み -->
                <div class="mt-6 flex flex-col-reverse sm:flex-row justify-end sm:space-x-3 space-y-2 sm:space-y-0 space-y-reverse">
                    <button type="button" id="staff-modal-cancel" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none w-full sm:w-auto">キャンセル</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 記録入力モーダル -->
    <div id="record-modal" class="fixed inset-0 z-20 hidden items-center justify-center p-4 modal-backdrop">
        <!-- p-4 sm:p-6 にしてスマホの余白を少し減らす -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-4 sm:p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- スマホ用にフォントサイズを調整 -->
            <h3 id="record-modal-user-name" class="text-xl sm:text-2xl font-bold mb-4 break-words"></h3>
            <form id="record-form">
                <input type="hidden" id="record-id">
                <input type="hidden" id="record-user-id">
                <!-- Removed photo hidden inputs -->
                 <div class="space-y-4">
                    <div>
                        <label for="record-homework" class="block text-sm font-medium text-gray-700">宿題</label>
                        <textarea id="record-homework" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="漢字ドリル、計算カードなど"></textarea>
                    </div>
                    <div>
                        <label for="record-worksheet" class="block text-sm font-medium text-gray-700">プリント学習</label>
                        <textarea id="record-worksheet" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ひらがな、数字の練習など"></textarea>
                    </div>
                     <div>
                        <label for="record-learning" class="block text-sm font-medium text-gray-700">ツリー式学習</label>
                        <textarea id="record-learning" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="国語、算数など"></textarea>
                    </div>
                     <div>
                        <label for="record-program" class="block text-sm font-medium text-gray-700">プログラム</label>
                        <textarea id="record-program" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="お月見うさぎ作りなど"></textarea>
                    </div>
                     <div>
                        <label for="record-freetime" class="block text-sm font-medium text-gray-700">自由時間</label>
                        <textarea id="record-freetime" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="パズル、ブロックなど"></textarea>
                    </div>
                    <div>
                        <label for="record-notes" class="block text-sm font-medium text-gray-700">連絡事項・特記事項 (保護者向け)</label>
                        <textarea id="record-notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="持ち物、次回の予定など"></textarea>
                    </div>
                    <div>
                        <label for="record-internal-notes" class="block text-sm font-medium text-gray-700">内部連絡メモ (スタッフ用)</label>
                        <textarea id="record-internal-notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-yellow-50" placeholder="引き継ぎ事項、要観察点など"></textarea>
                    </div>
                    <div>
                        <label for="record-staff" class="block text-sm font-medium text-gray-700">担当スタッフ</label>
                        <select id="record-staff" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <!-- Removed photo upload section -->
                    <!-- 保護者確認チェック -->
                    <div class="pt-4 border-t">
                         <button type="button" id="mark-report-sent-btn" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 disabled:opacity-50 disabled:cursor-not-allowed">保護者へ報告送信済みとしてマーク</button>
                    </div>
                </div>
                <!-- スマホでボタンを縦積み -->
                <div class="mt-6 flex flex-col-reverse sm:flex-row justify-between items-center sm:space-x-3 space-y-2 sm:space-y-0 space-y-reverse">
                    <div>
                         <button type="button" id="delete-record-btn" class="text-red-600 hover:text-red-800 text-sm font-medium hidden">この記録を削除</button>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-2 sm:space-y-0 w-full sm:w-auto">
                        <button type="button" id="record-modal-cancel" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none w-full sm:w-auto">キャンセル</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">保存</button>
                    </div>
                </div>
                 <div class="mt-6 border-t pt-6 space-y-2">
                     <button type="button" id="generate-report-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700">AIで報告文を新規作成</button>
                     <button type="button" id="view-saved-report-btn" class="w-full bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-600 hidden">保存した報告を表示</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 保護者向け報告モーダル -->
    <div id="report-modal" class="fixed inset-0 z-20 hidden items-center justify-center p-4 modal-backdrop">
        <!-- p-4 sm:p-6 にしてスマホの余白を少し減らす -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-4 sm:p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- スマホ用にフォントサイズを調整 -->
            <h3 class="text-xl sm:text-2xl font-bold mb-4">保護者向け報告（ツリー通信）</h3>
            <input type="hidden" id="report-modal-record-id">
            <div class="relative">
                <div id="report-loader" class="absolute inset-0 bg-white bg-opacity-75 flex-col items-center justify-center hidden">
                    <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">AIが報告文を作成中です...</p>
                </div>
                <label for="report-content" class="block text-sm font-medium text-gray-700">以下の内容を編集・コピーしてLINEなどで送信してください。</label>
                <textarea id="report-content" rows="12" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <!-- Revision Buttons -->
            <!-- スマホでボタンが折り返せるように flex-wrap と gap を使用 -->
            <div id="revision-buttons" class="mt-4 flex flex-wrap justify-center gap-2 hidden">
                <span class="text-sm text-gray-600 self-center w-full sm:w-auto text-center sm:text-left sm:mr-2">AIへの指示:</span>
                <button type="button" class="revision-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-300" data-instruction="longer">もう少し詳しく</button>
                <button type="button" class="revision-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-300" data-instruction="shorter">もっと簡潔に</button>
                <button type="button" class="revision-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-300" data-instruction="rephrase">表現を変えて</button>
            </div>
            <!-- スマホでボタンを縦積み -->
            <div class="mt-6 flex flex-col-reverse sm:flex-row justify-end sm:space-x-3 space-y-2 sm:space-y-0 space-y-reverse">
                <button type="button" id="report-modal-close" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none w-full sm:w-auto">閉じる</button>
                <button type="button" id="save-report-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 w-full sm:w-auto">報告を記録に保存</button>
                <button type="button" id="copy-report-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 w-full sm:w-auto">クリップボードにコピー</button>
            </div>
        </div>
    </div>

    <!-- 汎用確認モーダル -->
    <div id="confirm-modal" class="fixed inset-0 z-30 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4" id="confirm-modal-title">確認</h3>
            <p id="confirm-modal-message" class="text-gray-700 mb-6">この操作を続けてもよろしいですか？</p>
            <!-- スマホでボタンを縦積み -->
            <div class="flex flex-col-reverse sm:flex-row justify-end sm:space-x-3 space-y-2 sm:space-y-0 space-y-reverse">
                <button type="button" id="confirm-modal-cancel" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none w-full sm:w-auto">キャンセル</button>
                <button type="button" id="confirm-modal-ok" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 w-full sm:w-auto">削除する</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot,
            collection, query, where, addDoc, getDocs, serverTimestamp, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Removed Firebase Storage imports

        // --- Global Variables & Config -------------------------------------
        let db, auth, userId; // Removed storage
        let allUsers = [], dailyRecords = [], allStaff = [];
        let unsubscribeUsers = null, unsubscribeRecords = null, unsubscribeStaff = null;
        let currentReportContext = {};
        let allRecordsCache = []; // Cache for search

        // ★デプロイ用に修正 (重要): 'daily-report-app-prod' の部分は、Netlify FunctionsのappIdやFirebaseルールと一致させてください
        const appId = 'daily-report-app-prod'; // ★ 手順書ステップ2-5 (例: 'daily-report-app-prod')
        
        // ★デプロイ用に修正 (重要): ステップ2-3 (ユーザー提供のConfigに差し替え)
        const firebaseConfig = {
            apiKey: "AIzaSyDwXttBNHAjtWVhZg1K57EsWH-QwmYzqiw",
            authDomain: "tree-kids-school-daily-report.firebaseapp.com",
            projectId: "tree-kids-school-daily-report",
            storageBucket: "tree-kids-school-daily-report.firebasestorage.app",
            messagingSenderId: "433730968555",
            appId: "1:433730968555:web:667b060e6a9bc7975257ae"
        };

        // --- DOM Elements --------------------------------------------------
        const dailyTab = document.getElementById('tab-daily');
        const usersTab = document.getElementById('tab-users');
        const staffTab = document.getElementById('tab-staff');
        const dailyContent = document.getElementById('content-daily');
        const usersContent = document.getElementById('content-users');
        const staffContent = document.getElementById('content-staff');
        const datePicker = document.getElementById('date-picker');
        const dailyUserList = document.getElementById('daily-user-list');
        const userManagementList = document.getElementById('user-management-list');
        const staffManagementList = document.getElementById('staff-management-list');
        const userModal = document.getElementById('user-modal');
        const userForm = document.getElementById('user-form');
        const staffModal = document.getElementById('staff-modal');
        const staffForm = document.getElementById('staff-form');
        const recordModal = document.getElementById('record-modal');
        const recordForm = document.getElementById('record-form');
        const reportModal = document.getElementById('report-modal');
        const reportContent = document.getElementById('report-content');
        const copyReportBtn = document.getElementById('copy-report-btn');
        const saveReportBtn = document.getElementById('save-report-btn');
        const viewSavedReportBtn = document.getElementById('view-saved-report-btn');
        const revisionButtonsContainer = document.getElementById('revision-buttons');
        const confirmModal = document.getElementById('confirm-modal');
        const markReportSentBtn = document.getElementById('mark-report-sent-btn');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const clearSearchButton = document.getElementById('clear-search-button');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsDiv = document.getElementById('search-results');
        const dailyViewContainer = document.getElementById('daily-view-container');
        const exportUsersBtn = document.getElementById('export-users-btn');
        const exportRecordsBtn = document.getElementById('export-records-btn');
        // Removed photo related DOM elements


        // --- App Initialization --------------------------------------------
        async function initializeAppAndAuth() {
            try {
                // ★デプロイ用に修正: Configが空でないかだけチェック
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSy...")) { // apiKey startsWith check added for safety
                    alert("Firebaseの設定が完了していません。index.html ファイル内の `firebaseConfig` 変数を、Firebaseコンソールから取得した設定情報に書き換えてください。");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // Removed storage initialization
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with UID:", userId);
                        // ★デプロイ用に修正: 認証成功時にのみ初期化を実行
                        if (typeof initializeAppState === 'function' && !window.appInitialized) { // Add flag to prevent double init
                             window.appInitialized = true;
                             initializeAppState();
                        }
                    } else {
                        console.log("User not signed in.");
                        // ユーザーがいない場合、匿名サインインを試みる
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed in listener:", error);
                            alert("認証に失敗しました。Firebaseの Authentication 設定で「匿名」が有効になっているか確認してください。");
                        });
                    }
                });

                // ★デプロイ用に修正: Canvas用の if/else ブロックを削除 (ステップ2-4)
                // 認証は onAuthStateChanged がハンドルする
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }


            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert(`アプリの初期化に失敗しました: ${error.message}`);
            }
        }

        function initializeAppState() {
            // この関数が呼ばれた時点で認証は完了している
            console.log("initializeAppState called");
            setupEventListeners();
            datePicker.value = new Date().toISOString().split('T')[0];
            subscribeToUsers();
            subscribeToRecords(); // This will also populate allRecordsCache
            subscribeToStaff();
        }

        // --- Event Listeners -----------------------------------------------
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            dailyTab.addEventListener('click', () => switchTab('daily'));
            usersTab.addEventListener('click', () => switchTab('users'));
            staffTab.addEventListener('click', () => switchTab('staff'));

            datePicker.addEventListener('change', renderDailyUserList);
            document.getElementById('add-user-btn').addEventListener('click', openUserModalForCreate);
            document.getElementById('add-staff-btn').addEventListener('click', openStaffModalForCreate);

            userForm.addEventListener('submit', handleUserFormSubmit);
            staffForm.addEventListener('submit', handleStaffFormSubmit);
            recordForm.addEventListener('submit', handleRecordFormSubmit);

            document.getElementById('delete-record-btn').addEventListener('click', handleDeleteRecordClick);
            document.getElementById('generate-report-btn').addEventListener('click', handleGenerateReportClick);
            copyReportBtn.addEventListener('click', handleCopyReportClick);
            saveReportBtn.addEventListener('click', handleSaveReportClick);
            viewSavedReportBtn.addEventListener('click', handleViewSavedReportClick);
            document.getElementById('report-modal-close').addEventListener('click', closeReportModal);
            markReportSentBtn.addEventListener('click', handleMarkReportSentClick);
            searchButton.addEventListener('click', handleSearchClick);
            clearSearchButton.addEventListener('click', handleClearSearchClick);
             searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearchClick();
                }
            });

            // Add event listener for the daily list container (event delegation)
            dailyUserList.addEventListener('change', handleReportSentToggle);

            revisionButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('revision-btn')) {
                    const instruction = e.target.dataset.instruction;
                    handleRevisionRequest(instruction);
                }
            });

            // Removed photo event listeners

            // Export buttons
            exportUsersBtn.addEventListener('click', exportUsersToCSV);
            exportRecordsBtn.addEventListener('click', exportRecordsToCSV);


            // Modal close events
            userModal.addEventListener('click', closeUserModal);
            document.getElementById('user-modal-cancel').addEventListener('click', closeUserModal);
            staffModal.addEventListener('click', closeStaffModal);
            document.getElementById('staff-modal-cancel').addEventListener('click', closeStaffModal);
            recordModal.addEventListener('click', closeRecordModal);
            document.getElementById('record-modal-cancel').addEventListener('click', closeRecordModal);
        }

        // --- Tab Control ----------------------------------------------------
        function switchTab(activeTab) {
            console.log("Switching tab to:", activeTab);
            const tabs = { daily: dailyTab, users: usersTab, staff: staffTab };
            const contents = { daily: dailyContent, users: usersContent, staff: staffContent };

            for (const tabName in tabs) {
                const tab = tabs[tabName];
                const content = contents[tabName];
                if (tabName === activeTab) {
                    tab.classList.add('text-indigo-600', 'border-indigo-500');
                    tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                    content.classList.remove('hidden');
                } else {
                    tab.classList.remove('text-indigo-600', 'border-indigo-500');
                    tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                    content.classList.add('hidden');
                }
            }
             // Ensure search results are hidden when switching tabs away from daily
            if (activeTab !== 'daily') {
                handleClearSearchClick();
            }
        }

        // --- Firestore Subscriptions ---------------------------------------
        function subscribeToUsers() {
            if (unsubscribeUsers) unsubscribeUsers();
            console.log("Subscribing to users with appId:", appId);
            const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);
            unsubscribeUsers = onSnapshot(usersCollection, (snapshot) => {
                console.log("Received user snapshot");
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUsers.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                renderDailyUserList();
                renderUserManagementList();
                checkIfUsersExist();
            }, (error) => {
                console.error("Error listening to users:", error);
                if (error.code === 'permission-denied') {
                    alert("データベースへのアクセス権限がありません。FirebaseのFirestoreルールとappIdの設定を確認してください。");
                }
            });
        }

        function subscribeToStaff() {
            if (unsubscribeStaff) unsubscribeStaff();
             console.log("Subscribing to staff with appId:", appId);
            const staffCollection = collection(db, `artifacts/${appId}/public/data/staff`);
            unsubscribeStaff = onSnapshot(staffCollection, (snapshot) => {
                console.log("Received staff snapshot");
                allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allStaff.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                renderStaffManagementList();
                checkIfStaffExist();
            }, (error) => {
                 console.error("Error listening to staff:", error);
            });
        }

        function subscribeToRecords() {
            if (unsubscribeRecords) unsubscribeRecords();
             console.log("Subscribing to records with appId:", appId);
            const recordsCollection = collection(db, `artifacts/${appId}/public/data/records`);
            unsubscribeRecords = onSnapshot(recordsCollection, (snapshot) => {
                console.log("Received records snapshot");
                dailyRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRecordsCache = [...dailyRecords]; // Update cache for search
                renderDailyUserList();
            }, (error) => {
                 console.error("Error listening to records:", error);
            });
        }

        // --- Rendering Functions -------------------------------------------
       function renderDailyUserList() {
            if (!datePicker.value) return;
            dailyUserList.innerHTML = '';
            if (allUsers.length === 0) return;

            const selectedDate = datePicker.value;
            const recordsForDate = dailyRecords.filter(r => r.date === selectedDate);

            const homeUsers = [];
            const searchUsers = [];
            const unregisteredUsers = [];

            allUsers.forEach(user => {
                const userRecord = recordsForDate.find(r => r.userId === user.id);
                const attendance = userRecord ? userRecord.attendance : 'none';
                const reportSent = userRecord ? userRecord.reportSent : false;
                const recordId = userRecord ? userRecord.id : null;
                const userData = { user, attendance, reportSent, recordId };

                if (attendance === 'home') {
                    homeUsers.push(userData);
                } else if (attendance === 'search') {
                    searchUsers.push(userData);
                } else {
                    unregisteredUsers.push(userData);
                }
            });

            let finalHtml = '';

            const renderUserCard = (user, attendance, reportSent, recordId) => {
                const sentClass = reportSent ? 'report-sent' : '';
                const isPresent = attendance === 'home' || attendance === 'search';
                const checkboxDisabled = !isPresent ? 'disabled' : '';
                const checkedAttr = reportSent ? 'checked' : '';

                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm ${sentClass}">
                        <!-- スマホ用にレイアウト調整 -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <!-- Left Side: Checkbox + Name -->
                            <label class="report-sent-checkbox-label flex items-center mb-3 sm:mb-0">
                                <input type="checkbox" class="report-sent-checkbox h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                                    data-user-id="${user.id}" data-record-id="${recordId || ''}" ${checkedAttr} ${checkboxDisabled}>
                                
                                <div class="flex flex-col ml-3">
                                    <span class="font-bold text-lg">${user.name}</span>
                                    ${isPresent ? `<span class="report-sent-label-text ${reportSent ? 'text-green-600 font-medium' : ''}">${reportSent ? '✓ 報告済' : '報告済'}</span>` : ''}
                                </div>
                            </label>
                            
                            <!-- Right Side: Buttons -->
                            <!-- スマホでは右寄せ、ボタンサイズを少し調整 -->
                            <div class="flex items-center space-x-2 flex-shrink-0 self-end sm:self-center">
                                <button class="attendance-btn ${attendance === 'home' ? 'bg-green-500 text-white' : 'bg-gray-200'} px-3 py-1.5 sm:py-1 rounded-full text-sm" data-user-id="${user.id}" data-attendance="home">ホーム</button>
                                <button class="attendance-btn ${attendance === 'search' ? 'bg-yellow-500 text-white' : 'bg-gray-200'} px-3 py-1.5 sm:py-1 rounded-full text-sm" data-user-id="${user.id}" data-attendance="search">サーチ</button>
                                ${isPresent ? `<button class="record-input-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 sm:py-1 rounded-full text-sm" data-user-id="${user.id}">記録入力</button>` : ''}
                            </div>
                        </div>
                    </div>`;
            };

            if (homeUsers.length > 0) {
                finalHtml += `<div class="mb-4"><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">ホーム出席者</h3><div class="space-y-3">`;
                homeUsers.forEach(data => finalHtml += renderUserCard(data.user, data.attendance, data.reportSent, data.recordId));
                finalHtml += `</div></div>`;
            }

            if (searchUsers.length > 0) {
                finalHtml += `<div class="mb-4"><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">サーチ出席者</h3><div class="space-y-3">`;
                searchUsers.forEach(data => finalHtml += renderUserCard(data.user, data.attendance, data.reportSent, data.recordId));
                finalHtml += `</div></div>`;
            }
             if (homeUsers.length > 0 || searchUsers.length > 0) {
                 finalHtml += `<div class="mt-6 mb-2 border-t"></div>`;
            }

            if (unregisteredUsers.length > 0) {
                // For unregistered users, checkbox is disabled and has no record ID
                finalHtml += `<div class="space-y-3">`;
                unregisteredUsers.forEach(data => finalHtml += renderUserCard(data.user, data.attendance, data.reportSent, null));
                finalHtml += `</div>`;
            }

            dailyUserList.innerHTML = finalHtml;

            dailyUserList.querySelectorAll('.attendance-btn').forEach(btn => btn.addEventListener('click', handleAttendanceClick));
            dailyUserList.querySelectorAll('.record-input-btn').forEach(btn => btn.addEventListener('click', handleRecordInputClick));
             // Note: The checkbox listener is handled by event delegation on dailyUserList container
        }

        function renderUserManagementList() {
            userManagementList.innerHTML = '';
             if (allUsers.length === 0) return;

            allUsers.forEach(user => {
                const card = `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between sm:items-center">
                        <div class="mb-2 sm:mb-0">
                            <p class="font-bold text-lg">${user.name}</p>
                            <p class="text-sm text-gray-600">呼び方: ${user.nickname}</p>
                        </div>
                        <!-- スマホではボタンを右寄せ -->
                        <div class="flex items-center space-x-2 self-end sm:self-auto">
                            <button class="edit-user-btn bg-gray-200 hover:bg-gray-300 px-3 py-1.5 sm:py-1 rounded-full text-sm" data-user-id="${user.id}">編集</button>
                            <button class="delete-user-btn bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 sm:py-1 rounded-full text-sm" data-user-id="${user.id}">削除</button>
                        </div>
                    </div>`;
                userManagementList.insertAdjacentHTML('beforeend', card);
            });

            userManagementList.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', handleEditUserClick));
            userManagementList.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', handleDeleteUserClick));
        }

        function renderStaffManagementList() {
            staffManagementList.innerHTML = '';
             if (allStaff.length === 0) return;

            allStaff.forEach(staff => {
                const card = `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between sm:items-center">
                        <p class="font-bold text-lg mb-2 sm:mb-0">${staff.name}</p>
                        <!-- スマホではボタンを右寄せ -->
                        <div class="flex items-center space-x-2 self-end sm:self-auto">
                            <button class="edit-staff-btn bg-gray-200 hover:bg-gray-300 px-3 py-1.5 sm:py-1 rounded-full text-sm" data-staff-id="${staff.id}">編集</button>
                            <button class="delete-staff-btn bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 sm:py-1 rounded-full text-sm" data-staff-id="${staff.id}">削除</button>
                        </div>
                    </div>`;
                staffManagementList.insertAdjacentHTML('beforeend', card);
            });

            staffManagementList.querySelectorAll('.edit-staff-btn').forEach(btn => btn.addEventListener('click', handleEditStaffClick));
            staffManagementList.querySelectorAll('.delete-staff-btn').forEach(btn => btn.addEventListener('click', handleDeleteStaffClick));
        }


        function checkIfUsersExist() {
            const noUsersDaily = document.getElementById('no-users-message-daily');
            const noUsersManage = document.getElementById('no-users-message-manage');
            if(allUsers.length === 0) {
                noUsersDaily.classList.remove('hidden');
                noUsersManage.classList.remove('hidden');
            } else {
                noUsersDaily.classList.add('hidden');
                noUsersManage.classList.add('hidden');
            }
        }

        function checkIfStaffExist() {
            const noStaffManage = document.getElementById('no-staff-message-manage');
            if(allStaff.length === 0) {
                noStaffManage.classList.remove('hidden');
            } else {
                noStaffManage.classList.add('hidden');
            }
        }

        function renderSearchResults(results) {
            searchResultsDiv.innerHTML = '';
            if (results.length === 0) {
                searchResultsDiv.innerHTML = '<p class="text-gray-500">該当する記録が見つかりませんでした。</p>';
                return;
            }

            results.forEach(record => {
                const user = allUsers.find(u => u.id === record.userId);
                if (!user) return; // Skip if user not found (edge case)

                // Simple snippet generation (improve later if needed)
                let snippet = `記録内容: ${ (record.homework || record.worksheet || record.learning || record.program || record.freetime || record.notes || record.internalNotes || record.generatedReport || '').substring(0, 50)}...`;

                 const card = `
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 hover:border-blue-400 cursor-pointer search-result-item" data-record-id="${record.id}" data-user-id="${user.id}">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-blue-600">${user.name}</span>
                            <span class="text-sm text-gray-500">${record.date}</span>
                        </div>
                        <p class="text-sm text-gray-600 break-words">${snippet}</p>
                    </div>`;
                searchResultsDiv.insertAdjacentHTML('beforeend', card);
            });
             // Add click listeners to search results
            searchResultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', handleSearchResultClick);
            });
        }

        // --- Event Handlers ------------------------------------------------
        async function handleAttendanceClick(e) {
            const userId = e.target.dataset.userId;
            const attendance = e.target.dataset.attendance;
            const selectedDate = datePicker.value;

            const existingRecord = dailyRecords.find(r => r.date === selectedDate && r.userId === userId);

            if (existingRecord) {
                const newAttendance = existingRecord.attendance === attendance ? 'none' : attendance;
                const recordRef = doc(db, `artifacts/${appId}/public/data/records`, existingRecord.id);
                if (newAttendance === 'none') {
                    // Delete record if toggled back to none
                    await deleteDoc(recordRef);
                } else {
                     // Reset reportSent status only if changing attendance type (home -> search or vice versa)
                     // or coming from 'none' state. Don't reset if clicking the same button twice.
                    const updateData = { attendance: newAttendance };
                     if (existingRecord.attendance !== newAttendance) {
                         updateData.reportSent = false;
                     }
                    await setDoc(recordRef, updateData, { merge: true });
                }
            } else {
                 if (attendance !== 'none') { // Only add if it's home or search
                    await addDoc(collection(db, `artifacts/${appId}/public/data/records`), {
                        userId,
                        date: selectedDate,
                        attendance,
                        reportSent: false, // Default to false
                        createdAt: serverTimestamp()
                    });
                }
            }
        }

        function handleRecordInputClick(e) {
            const userId = e.target.dataset.userId;
            const user = allUsers.find(u => u.id === userId);
            const record = dailyRecords.find(r => r.date === datePicker.value && r.userId === userId);
            openRecordModal(user, record);
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const user = {
                name: document.getElementById('user-name').value,
                nickname: document.getElementById('user-nickname').value,
            };
            try {
                const userRef = id ? doc(db, `artifacts/${appId}/public/data/users`, id) : doc(collection(db, `artifacts/${appId}/public/data/users`));
                await setDoc(userRef, user, { merge: true });
                closeUserModal();
            } catch (error) {
                console.error("Error saving user:", error);
            }
        }

        async function handleStaffFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('staff-id').value;
            const staff = {
                name: document.getElementById('staff-name').value,
            };
            try {
                const staffRef = id ? doc(db, `artifacts/${appId}/public/data/staff`, id) : doc(collection(db, `artifacts/${appId}/public/data/staff`));
                await setDoc(staffRef, staff, { merge: true });
                closeStaffModal();
            } catch (error) {
                console.error("Error saving staff:", error);
            }
        }

        async function handleRecordFormSubmit(e) {
            e.preventDefault();
            let recordId = document.getElementById('record-id').value;
            const userId = document.getElementById('record-user-id').value;
            const selectedDate = datePicker.value;

            const existingRecord = dailyRecords.find(r => r.date === selectedDate && r.userId === userId);
            const attendanceStatus = existingRecord ? existingRecord.attendance : 'none';
            const reportSentStatus = existingRecord ? existingRecord.reportSent : false; // Preserve existing status

            const recordData = {
                userId: userId,
                date: selectedDate,
                attendance: attendanceStatus,
                homework: document.getElementById('record-homework').value,
                worksheet: document.getElementById('record-worksheet').value,
                learning: document.getElementById('record-learning').value,
                program: document.getElementById('record-program').value,
                freetime: document.getElementById('record-freetime').value,
                notes: document.getElementById('record-notes').value,
                internalNotes: document.getElementById('record-internal-notes').value, // Save internal notes
                staff: document.getElementById('record-staff').value,
                reportSent: reportSentStatus, // Make sure to save the status
                updatedAt: serverTimestamp()
            };

            let recordRef;
            if (recordId) {
                recordRef = doc(db, `artifacts/${appId}/public/data/records`, recordId);
            } else if (existingRecord) {
                recordRef = doc(db, `artifacts/${appId}/public/data/records`, existingRecord.id);
                recordId = existingRecord.id; // Make sure to use existing record ID
            } else {
                recordRef = doc(collection(db, `artifacts/${appId}/public/data/records`));
                recordId = recordRef.id;
                document.getElementById('record-id').value = recordId; // Set ID in form if new
            }

            try {
                // Save text data first
                await setDoc(recordRef, recordData, { merge: true });
                closeRecordModal();
            } catch (error) {
                console.error("Error saving record:", error);
                alert("記録の保存中にエラーが発生しました。");
            }
        }


        function handleEditUserClick(e) {
            const userId = e.target.dataset.userId;
            const user = allUsers.find(u => u.id === userId);
            openUserModalForEdit(user);
        }

        function handleEditStaffClick(e) {
            const staffId = e.target.dataset.staffId;
            const staff = allStaff.find(s => s.id === staffId);
            openStaffModalForEdit(staff);
        }

        function handleDeleteUserClick(e) {
            const userId = e.target.dataset.userId;
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            showConfirmModal(
                `本当に削除しますか？`,
                `${user.name}さんの情報を削除します。関連する過去の記録は削除されません。`,
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userId));
                        console.log("User deleted successfully");
                    } catch (error) {
                        console.error("Error deleting user:", error);
                    }
                }
            );
        }

        function handleDeleteStaffClick(e) {
            const staffId = e.target.dataset.staffId;
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) return;

            showConfirmModal(
                `本当に削除しますか？`,
                `${staff.name}さんの情報を削除します。`,
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/staff`, staffId));
                        console.log("Staff deleted successfully");
                    } catch (error) {
                        console.error("Error deleting staff:", error);
                    }
                }
            );
        }

        async function handleDeleteRecordClick() {
            const recordId = document.getElementById('record-id').value;
            if (!recordId) return;

            showConfirmModal(
                '記録を削除しますか？',
                '入力した内容がすべて削除されます。この操作は元に戻せません。',
                async () => {
                     try {
                        // Delete record from firestore
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/records`, recordId));
                        console.log("Record deleted successfully");
                        closeRecordModal();
                    } catch (error) {
                        console.error("Error deleting record:", error);
                    }
                }
            );
        }

        async function handleGenerateReportClick() {
            const recordId = document.getElementById('record-id').value;
             if (!recordId) {
                alert("記録がまだ保存されていません。先に「保存」ボタンを押してください。");
                return;
            }

            const userId = document.getElementById('record-user-id').value;
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const staffName = document.getElementById('record-staff').value || '担当スタッフ';
            const activityNotes = `宿題: ${document.getElementById('record-homework').value}\nプリント学習: ${document.getElementById('record-worksheet').value}\nツリー式学習: ${document.getElementById('record-learning').value}\nプログラム: ${document.getElementById('record-program').value}\n自由時間: ${document.getElementById('record-freetime').value}\n連絡事項・特記事項: ${document.getElementById('record-notes').value}`;
             // Note: Internal notes are NOT included here

            currentReportContext = { user, staffName, activityNotes };
            document.getElementById('report-modal-record-id').value = recordId;

            openReportModal(true); // true indicates a new report is being generated
            // ★デプロイ用に修正: Netlify Function を呼び出す
            await generateReportWithAI_Netlify(user, staffName, activityNotes);
        }

        function handleCopyReportClick() {
            reportContent.select();
            try {
                document.execCommand('copy');
                copyReportBtn.textContent = 'コピーしました！';
                setTimeout(() => { copyReportBtn.textContent = 'クリップボードにコピー'; }, 2000);
            } catch (err) {
                alert('コピーに失敗しました。');
            }
        }

        async function handleSaveReportClick() {
            const recordId = document.getElementById('report-modal-record-id').value;
            const reportText = reportContent.value;

            if (!recordId || !reportText) {
                alert("保存する内容がありません。");
                return;
            }

            try {
                const recordRef = doc(db, `artifacts/${appId}/public/data/records`, recordId);
                await updateDoc(recordRef, {
                    generatedReport: reportText
                });
                saveReportBtn.textContent = '保存しました！';
                setTimeout(() => {
                    saveReportBtn.textContent = '報告を記録に保存';
                }, 2000);
                 // Optionally mark as sent when saved? Or keep it separate. Keep separate for now.
            } catch (error) {
                console.error("Error saving report:", error);
                alert("報告の保存に失敗しました。");
            }
        }

        function handleViewSavedReportClick() {
            const recordId = document.getElementById('record-id').value;
            const record = dailyRecords.find(r => r.id === recordId);
            if (record && record.generatedReport) {
                openReportModal(false); // false indicates viewing a saved report
                reportContent.value = record.generatedReport;
                document.getElementById('report-modal-record-id').value = recordId;
            } else {
                alert("保存された報告が見つかりません。");
            }
        }

         async function handleMarkReportSentClick() {
            const recordId = document.getElementById('record-id').value;
            if (!recordId) {
                alert("記録がまだ保存されていません。");
                return;
            }

            const recordRef = doc(db, `artifacts/${appId}/public/data/records`, recordId);
            try {
                // This button just marks it as TRUE
                await updateDoc(recordRef, { reportSent: true });
                markReportSentBtn.textContent = '✓ 報告送信済み';
                markReportSentBtn.disabled = true;
                 // Optionally close the modal
                 // closeRecordModal();
            } catch (error) {
                console.error("Error marking report as sent:", error);
                alert("送信済みマークの更新に失敗しました。");
            }
        }

        async function handleReportSentToggle(e) {
            if (e.target.classList.contains('report-sent-checkbox')) {
                const checkbox = e.target;
                const recordId = checkbox.dataset.recordId;
                const newStatus = checkbox.checked;

                if (!recordId) {
                    // Should not happen if checkbox is enabled, but good to check
                    console.warn("Cannot toggle report status: record ID not found.");
                    checkbox.checked = !newStatus; // Revert visually
                    return;
                }

                const recordRef = doc(db, `artifacts/${appId}/public/data/records`, recordId);
                try {
                    await updateDoc(recordRef, { reportSent: newStatus });
                    // Visual update will happen automatically via onSnapshot re-render
                } catch (error) {
                    console.error("Error updating report sent status:", error);
                    alert("報告済み状態の更新に失敗しました。");
                    checkbox.checked = !newStatus; // Revert visually on error
                }
            }
        }


        async function handleRevisionRequest(instruction) {
            const originalReport = reportContent.value;
            if (!originalReport || !currentReportContext.user) {
                alert("修正する元の報告がありません。");
                return;
            }

            // Show loader
            document.getElementById('report-loader').style.display = 'flex';
            revisionButtonsContainer.classList.add('hidden');

            // ★デプロイ用に修正: Netlify Function を呼び出す
            await generateReportWithAI_Netlify(
                currentReportContext.user,
                currentReportContext.staffName,
                currentReportContext.activityNotes,
                { instruction, originalReport }
            );
        }

        // Removed photo handlers

         // --- Search Functions ---
        function handleSearchClick() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                handleClearSearchClick(); // Clear if search term is empty
                return;
            }

            const results = allRecordsCache.filter(record => {
                const user = allUsers.find(u => u.id === record.userId);
                const userName = user ? user.name.toLowerCase() : '';
                const userNickname = user ? user.nickname.toLowerCase() : '';

                return (
                    (record.homework && record.homework.toLowerCase().includes(searchTerm)) ||
                    (record.worksheet && record.worksheet.toLowerCase().includes(searchTerm)) ||
                    (record.learning && record.learning.toLowerCase().includes(searchTerm)) ||
                    (record.program && record.program.toLowerCase().includes(searchTerm)) ||
                    (record.freetime && record.freetime.toLowerCase().includes(searchTerm)) ||
                    (record.notes && record.notes.toLowerCase().includes(searchTerm)) ||
                    (record.internalNotes && record.internalNotes.toLowerCase().includes(searchTerm)) || // Search internal notes
                    (record.generatedReport && record.generatedReport.toLowerCase().includes(searchTerm)) ||
                    (record.staff && record.staff.toLowerCase().includes(searchTerm)) ||
                    userName.includes(searchTerm) ||
                    userNickname.includes(searchTerm)
                );
            });

             // Sort results by date descending
            results.sort((a, b) => new Date(b.date) - new Date(a.date));


            dailyViewContainer.classList.add('hidden'); // Hide daily list
            searchResultsContainer.classList.remove('hidden'); // Show results container
            clearSearchButton.classList.remove('hidden'); // Show clear button
            renderSearchResults(results);
        }

        function handleClearSearchClick() {
            searchInput.value = '';
            searchResultsContainer.classList.add('hidden'); // Hide results
            searchResultsDiv.innerHTML = '';
            clearSearchButton.classList.add('hidden'); // Hide clear button
            dailyViewContainer.classList.remove('hidden'); // Show daily list
            renderDailyUserList(); // Re-render daily list for the selected date
        }

         function handleSearchResultClick(e) {
            const target = e.target.closest('.search-result-item');
            if (!target) return;

            const recordId = target.dataset.recordId;
            const userId = target.dataset.userId;

            const record = allRecordsCache.find(r => r.id === recordId);
            const user = allUsers.find(u => u.id === userId);

            if (record && user) {
                // Set the date picker to the record's date before opening
                datePicker.value = record.date;
                // Open the modal with the specific record found
                openRecordModal(user, record);
            } else {
                console.error("Could not find record or user for search result:", recordId, userId);
                alert("記録の表示に失敗しました。");
            }
        }


        // --- Modal Control Functions ---------------------------------------
        function openUserModalForCreate() {
            userForm.reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-modal-title').textContent = '利用者を新規登録';
            userModal.style.display = 'flex';
        }

        function openUserModalForEdit(user) {
            userForm.reset();
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-nickname').value = user.nickname;
            document.getElementById('user-modal-title').textContent = '利用者情報を編集';
            userModal.style.display = 'flex';
        }

        function closeUserModal() {
            userModal.style.display = 'none';
        }

        function openStaffModalForCreate() {
            staffForm.reset();
            document.getElementById('staff-id').value = '';
            document.getElementById('staff-modal-title').textContent = 'スタッフを新規登録';
            staffModal.style.display = 'flex';
        }

        function openStaffModalForEdit(staff) {
            staffForm.reset();
            document.getElementById('staff-id').value = staff.id;
            document.getElementById('staff-name').value = staff.name;
            document.getElementById('staff-modal-title').textContent = 'スタッフ情報を編集';
            staffModal.style.display = 'flex';
        }

        function closeStaffModal() {
            staffModal.style.display = 'none';
        }

        function openRecordModal(user, record) {
            recordForm.reset();
            document.getElementById('record-modal-user-name').textContent = `${user.name} さんの記録`;
            document.getElementById('record-user-id').value = user.id;
            document.getElementById('record-internal-notes').value = ''; // Clear internal notes initially

            const staffSelect = document.getElementById('record-staff');
            staffSelect.innerHTML = '<option value="">選択してください</option>';
            allStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                staffSelect.appendChild(option);
            });

             // Reset and configure the mark as sent button
            markReportSentBtn.disabled = false;
            markReportSentBtn.textContent = '保護者へ報告送信済みとしてマーク';

            if (record) {
                document.getElementById('record-id').value = record.id;
                document.getElementById('record-homework').value = record.homework || '';
                document.getElementById('record-worksheet').value = record.worksheet || '';
                document.getElementById('record-learning').value = record.learning || '';
                document.getElementById('record-program').value = record.program || '';
                document.getElementById('record-freetime').value = record.freetime || '';
                document.getElementById('record-notes').value = record.notes || '';
                document.getElementById('record-internal-notes').value = record.internalNotes || ''; // Load internal notes
                staffSelect.value = record.staff || '';
                document.getElementById('delete-record-btn').classList.remove('hidden');

                // Removed photo loading logic

                if (record.generatedReport) {
                    viewSavedReportBtn.classList.remove('hidden');
                } else {
                    viewSavedReportBtn.classList.add('hidden');
                }
                 // Update mark as sent button based on saved status
                if (record.reportSent) {
                    markReportSentBtn.textContent = '✓ 報告送信済み';
                    markReportSentBtn.disabled = true;
                }

            } else {
                 document.getElementById('record-id').value = '';
                 document.getElementById('delete-record-btn').classList.add('hidden');
                 viewSavedReportBtn.classList.add('hidden');
                 markReportSentBtn.disabled = true; // Disable if no record saved yet
                 markReportSentBtn.textContent = '記録保存後にマーク可能';
            }

            recordModal.style.display = 'flex';
        }


        function closeRecordModal() {
            recordModal.style.display = 'none';
        }

        function openReportModal(isGenerating) {
            reportContent.value = '';
            revisionButtonsContainer.classList.add('hidden');

            if (isGenerating) {
                document.getElementById('report-loader').style.display = 'flex';
                saveReportBtn.style.display = 'inline-flex';
            } else {
                document.getElementById('report-loader').style.display = 'none';
                saveReportBtn.style.display = 'none'; // Hide save button when viewing saved
            }
            reportModal.style.display = 'flex';
        }

        function closeReportModal() {
            reportModal.style.display = 'none';
            document.getElementById('report-modal-record-id').value = ''; // Clear ID on close
            currentReportContext = {}; // Clear context on close
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;

            const okButton = document.getElementById('confirm-modal-ok');
            const cancelButton = document.getElementById('confirm-modal-cancel');

            // Re-clone buttons to ensure event listeners are fresh
            const okClone = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(okClone, okButton);

            const cancelClone = cancelButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(cancelClone, cancelButton);

            okClone.addEventListener('click', () => {
                onConfirm(); // Execute the specific action
                confirmModal.style.display = 'none';
            });
            cancelClone.addEventListener('click', () => {
                confirmModal.style.display = 'none';
            });

            confirmModal.style.display = 'flex';
        }

        // --- Helper Functions ------------------------------------------------
        async function getRecentRecordsForUser(userId) {
            // Use the cache instead of querying Firestore every time for report generation
             const userRecords = allRecordsCache.filter(r => r.userId === userId);
             userRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
             return userRecords.slice(0, 5);

        }

        // --- CSV Export Functions ---
        function escapeCSV(str) {
            if (typeof str !== 'string') str = String(str || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Excel UTF-8 support
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        function exportUsersToCSV() {
            if (allUsers.length === 0) {
                alert("エクスポートする利用者がいません。");
                return;
            }
            const headers = ["利用者ID", "氏名", "呼び方"];
            const rows = allUsers.map(user => [
                escapeCSV(user.id),
                escapeCSV(user.name),
                escapeCSV(user.nickname)
            ]);

            let csvContent = headers.join(",") + "\n";
            rows.forEach(rowArray => {
                let row = rowArray.join(",");
                csvContent += row + "\n";
            });

            downloadCSV(csvContent, `users_export_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportRecordsToCSV() {
            if (allRecordsCache.length === 0) {
                 alert("エクスポートする記録がありません。");
                return;
            }
             // Sort records by date and then by user name for better readability
            const sortedRecords = [...allRecordsCache].sort((a, b) => {
                const dateComparison = new Date(a.date) - new Date(b.date);
                if (dateComparison !== 0) return dateComparison;
                const userA = allUsers.find(u => u.id === a.userId);
                const userB = allUsers.find(u => u.id === b.userId);
                const nameA = userA ? userA.name : '';
                const nameB = userB ? userB.name : '';
                return nameA.localeCompare(nameB, 'ja');
            });


            const headers = [
                "記録ID", "日付", "利用者ID", "利用者名", "出席場所",
                "宿題", "プリント学習", "ツリー式学習", "プログラム", "自由時間",
                "連絡事項(保護者)", "内部メモ", "担当スタッフ", /* Removed Photo URL */ "報告済み",
                "保存した報告文"
                // Timestamps can be added if needed: "作成日時", "最終更新日時"
            ];
            const rows = sortedRecords.map(record => {
                 const user = allUsers.find(u => u.id === record.userId);
                 const userName = user ? user.name : '不明';
                 const attendanceMap = {'home': 'ホーム', 'search': 'サーチ', 'none': '未選択', undefined: '未選択'};

                 return [
                    escapeCSV(record.id),
                    escapeCSV(record.date),
                    escapeCSV(record.userId),
                    escapeCSV(userName),
                    escapeCSV(attendanceMap[record.attendance] || record.attendance), // Handle 'none' or undefined
                    escapeCSV(record.homework),
                    escapeCSV(record.worksheet),
                    escapeCSV(record.learning),
                    escapeCSV(record.program),
                    escapeCSV(record.freetime),
                    escapeCSV(record.notes),
                    escapeCSV(record.internalNotes),
                    escapeCSV(record.staff),
                    // escapeCSV(record.photoURL), // Removed Photo URL
                    escapeCSV(record.reportSent ? 'はい' : 'いいえ'),
                    escapeCSV(record.generatedReport)
                 ];
            });

            let csvContent = headers.join(",") + "\n";
            rows.forEach(rowArray => {
                let row = rowArray.join(",");
                csvContent += row + "\n";
            });

            downloadCSV(csvContent, `records_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        // --- End CSV Export Functions ---

        // ★デプロイ用に修正: Netlify Functionを呼び出すラッパー関数
        async function generateReportWithAI_Netlify(user, staffName, activityNotes, revisionRequest = null) {
            const loader = document.getElementById('report-loader');
            const reportTextArea = document.getElementById('report-content');
            
            loader.style.display = 'flex';
            revisionButtonsContainer.classList.add('hidden'); // Hide revision buttons during load

            try {
                // Netlify Functionのエンドポイントを呼び出す
                const response = await fetch('/.netlify/functions/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appId: appId, // ★修正: 固定したappIdを渡す
                        user: { id: user.id, nickname: user.nickname }, // ユーザーオブジェクト全体ではなく、必要な情報だけを渡す
                        staffName: staffName,
                        activityNotes: activityNotes,
                        revisionRequest: revisionRequest
                    }),
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: "レスポンスの解析に失敗しました。" }));
                    throw new Error(`AIサーバーとの通信に失敗しました (Status: ${response.status}): ${errorBody.error || response.statusText}`);
                }

                const result = await response.json();

                if (result.report) {
                    reportTextArea.value = result.report;
                    revisionButtonsContainer.classList.remove('hidden'); // Show revision buttons on success
                } else {
                    throw new Error(result.error || "AIからの応答が不正です。");
                }

            } catch (error) {
                console.error("Error calling Netlify function:", error);
                reportTextArea.value = `エラーが発生しました: ${error.message}. Netlifyの環境変数（APIキーとサービスアカウント）が正しく設定されているか確認してください。`;
                revisionButtonsContainer.classList.add('hidden'); // Hide buttons on error
            } finally {
                 // ★修正: ローディング表示を確実に消す
                loader.style.display = 'none';
            }
        }
        
        // --- Initialize App ------------------------------------------------
        initializeAppAndAuth();

    </script>
</body>
</html>